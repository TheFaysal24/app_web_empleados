{% extends "base.html" %}
{% block title %}Asignar Turnos{% endblock %}

{% block content %}
<div class="turnos-container">

  <!-- Navegación Superior -->
  <div class="top-nav">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
      <i class="fas fa-arrow-left"></i> Volver al Dashboard
    </a>
    <h2 class="page-title">Asignación de Turnos</h2>
    <!-- Navegación de Semanas -->
    <div class="week-nav">
      <a href="{{ url_for('admin_asignar_turnos', semana_offset=semana_offset-1) }}" class="btn btn-info btn-sm">
        <i class="fas fa-chevron-left"></i> Semana Anterior
      </a>
      <span class="current-week">
        Semana del {{ inicio_semana.strftime('%d de %b') }} al {{ fin_semana.strftime('%d de %b, %Y') }}
      </span>
      <a href="{{ url_for('admin_asignar_turnos', semana_offset=semana_offset+1) }}" class="btn btn-info btn-sm">
        Semana Siguiente <i class="fas fa-chevron-right"></i>
      </a>
    </div>
  </div>

  <!-- Formulario principal -->
  <form method="POST" action="{{ url_for('admin_asignar_turnos') }}">
    {{ form.hidden_tag() }}
    <!-- Campo oculto para saber qué semana estamos guardando -->
    <input type="hidden" name="semana_offset" value="{{ semana_offset }}">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title text-gradient">
          <i class="fas fa-calendar-plus"></i> Planificación Semanal
        </h3>
        <p class="card-subtitle">
          Asigna, edita o corrige los turnos para cada usuario.
        </p>
      </div>

      <div class="table-responsive">
        <table class="table table-turnos">
          <thead>
            <tr>
              <th class="user-header">Usuario</th>
              {% for fecha in fechas_semana %}
                <th class="day-header">
                  {{ fecha.strftime('%A')|capitalize }}<br>
                  <small>{{ fecha.strftime('%d/%m') }}</small>
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for usuario in usuarios %}
            <tr>
              <td class="user-cell">
                <div class="user-info-cell">
                  <i class="fas fa-user-circle"></i>
                  <span>{{ usuario.nombre }}</span>
                  <small>{{ usuario.cargo }}</small>
                </div>
              </td>
              {% for fecha in fechas_semana %}
              <td>
                <div class="form-group-table">
                  <!-- El nombre del campo es `id_usuario-fecha` -->
                  <select name="{{ usuario.id }}-{{ fecha.isoformat() }}" class="form-control form-control-sm">
                    <option value="">-- Descanso --</option>
                    {% set turno_actual = turnos_asignados.get(usuario.id, {}).get(fecha.isoformat()) %}
                    {% for turno_disponible in turnos_disponibles %}
                      <option value="{{ turno_disponible.id }}" {% if turno_actual and turno_actual == turno_disponible.id %}selected{% endif %}>
                        {{ turno_disponible.hora }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              {% endfor %}
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center p-3">No hay usuarios para mostrar.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Botón de Guardar Fijo -->
    <div class="submit-container">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fas fa-save"></i> Guardar Cambios
      </button>
    </div>
  </form>
</div>

<style>
  body {
    background: #f4f7f6;
  }
  .turnos-container {
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
  }
  .top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 15px 25px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
    margin-bottom: 25px;
  }
  .page-title {
    margin: 0;
    font-size: 1.6em;
    font-weight: 700;
    color: #333;
  }
  .week-nav {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .current-week {
    font-weight: 600;
    color: #555;
  }
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.08);
    border: none;
  }
  .card-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }
  .text-gradient {
    background: -webkit-linear-gradient(#fff, #e0e0e0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .table-turnos thead th {
    background-color: #f8f9fa;
    text-align: center;
    vertical-align: middle;
    font-weight: 600;
    color: #495057;
    padding: 15px;
  }
  .user-header { text-align: left !important; }
  .user-cell {
    font-weight: 700;
    color: #343a40;
    background-color: #f8f9fa;
  }
  .user-info-cell {
    display: flex;
    flex-direction: column;
  }
  .user-info-cell small {
    font-size: 0.8em;
    color: #6c757d;
  }
  .table-turnos select {
    min-width: 120px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
  }
  .table-turnos select:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
  }
  .submit-container {
    position: sticky;
    bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    text-align: center;
    margin-top: 20px;
  }
</style>
{% endblock %}