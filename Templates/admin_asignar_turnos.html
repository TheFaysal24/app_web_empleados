{% extends "base.html" %}
{% block title %}Asignar Turnos{% endblock %}

{% block content %}
<div class="turnos-container">

  <!-- Navegación Superior -->
  <div class="top-nav">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
      <i class="fas fa-arrow-left"></i> Volver al Dashboard
    </a>
    <h2 class="page-title">Asignación Mensual de Turnos</h2>
    <!-- Navegación de Mes y Año -->
    <div class="month-nav-form">
      <form method="GET" action="{{ url_for('admin_asignar_turnos') }}" class="d-flex align-items-center gap-2">
        <select name="mes" class="form-select form-select-sm">
          {% for i in range(1, 13) %}
            <option value="{{ i }}" {% if i == mes_actual %}selected{% endif %}>{{ meses_nombres[i] }}</option>
          {% endfor %}
        </select>
        <select name="ano" class="form-select form-select-sm">
          {% for ano in anos_disponibles %}
            <option value="{{ ano }}" {% if ano == ano_actual %}selected{% endif %}>{{ ano }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="fas fa-search"></i> Ir
        </button>
      </form>
    </div>
  </div>

  <!-- Formulario principal -->
  <form method="POST" action="{{ url_for('admin_asignar_turnos') }}">
    {{ form.hidden_tag() }}
    <!-- Campos ocultos para saber qué mes/año estamos guardando -->
    <input type="hidden" name="mes_actual" value="{{ mes_actual }}">
    <input type="hidden" name="ano_actual" value="{{ ano_actual }}">

    {% for semana_num, fechas_semana in calendario_mensual.items() %}
    <div class="card">
      <div class="card-header">
        <h3 class="card-title text-gradient">
          <i class="fas fa-calendar-week"></i> 
          Semana {{ semana_num }} 
          <small>({{ fechas_semana[0].strftime('%d %b') }} - {{ fechas_semana[-1].strftime('%d %b') }})</small>
        </h3>
        <p class="card-subtitle">
          Asigna, edita o corrige los turnos para cada usuario.
        </p>
      </div>

      <div class="table-responsive">
        <table class="table table-turnos">
          <thead>
            <tr>
              <th class="user-header">Usuario</th>
              {% for fecha in fechas_semana %}
                <th class="day-header">
                  {{ fecha.strftime('%A')|capitalize }}<br>
                  <small class="text-muted">{{ fecha.strftime('%d/%m') }}</small>
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for usuario in usuarios %}
            <tr>
              <td class="user-cell">
                <div class="user-info-cell">
                  <i class="fas fa-user-tie"></i>
                  <span>{{ usuario.username }}</span>
                </div>
              </td>
              {% for fecha in fechas_semana %}
              <td>
                <div class="form-group-table">
                  <select name="turno-{{ usuario.id }}-{{ fecha.isoformat() }}" class="form-control form-control-sm">
                    <option value="descanso">-- Descanso --</option>
                    {% set turno_actual_id = turnos_asignados.get(fecha.isoformat(), {}).get(usuario.id) %}
                    {% for turno_disponible in turnos_disponibles %}
                      {% set hora_obj = datetime.datetime.strptime(turno_disponible.hora, '%H:%M') %}
                      
                      {# Agrupar por franja horaria para una mejor UX #}
                      {% if loop.first %}
                        <optgroup label="Mañana">
                      {% elif loop.index0 > 0 and hora_obj.hour >= 12 and datetime.datetime.strptime(turnos_disponibles[loop.index0-1].hora, '%H:%M').hour < 12 %}
                        <optgroup label="Tarde">
                      {% elif loop.index0 > 0 and hora_obj.hour >= 18 and datetime.datetime.strptime(turnos_disponibles[loop.index0-1].hora, '%H:%M').hour < 18 %}
                        <optgroup label="Noche">
                      {% endif %}

                      {# Para encontrar el ID correcto, necesitamos buscarlo en la tabla completa #}
                      <option value="{{ turno_disponible.id if turno_disponible.id is defined else '' }}" {% if turno_actual_id == turno_disponible.id %}selected{% endif %}>
                        {{ hora_obj.strftime('%-I:%M %p') }}
                      </option>

                      {% if (loop.index < loop.length and datetime.datetime.strptime(turnos_disponibles[loop.index].hora, '%H:%M').hour >= 12 and hora_obj.hour < 12) %}
                        </optgroup>
                      {% elif (loop.index < loop.length and datetime.datetime.strptime(turnos_disponibles[loop.index].hora, '%H:%M').hour >= 18 and hora_obj.hour < 18) %}
                        </optgroup>
                      {% elif loop.last %}
                        </optgroup>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </td>
              {% endfor %}
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center p-3">No hay usuarios para mostrar.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}

    <!-- Botón de Guardar Fijo -->
    <div class="submit-container">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fas fa-save"></i> Guardar Cambios
      </button>
    </div>
  </form>
</div>

<style>
  body {
    background: #f4f7f6;
  }
  .turnos-container {
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
  }
  .top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 15px 25px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
    margin-bottom: 25px;
  }
  .page-title {
    margin: 0;
    font-size: 1.6em;
    font-weight: 700;
    color: #333;
  }
  .month-nav-form {
    display: flex;
    align-items: center;
  }
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.08);
    border: none;
  }
  .card + .card { margin-top: 25px; } /* Espacio entre tarjetas de semana */
  .card-header {
    background: linear-gradient(135deg, #2563eb, #3b82f6); /* Azul Primario */
    color: white;
    padding: 20px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
  }
  .card-header small {
    font-weight: 400;
    opacity: 0.8;
  }
  .text-gradient {
    background: -webkit-linear-gradient(#fff, #e0e0e0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .table-turnos thead th {
    background-color: #f8f9fa;
    text-align: center;
    vertical-align: middle;
    font-weight: 600;
    color: #495057;
    padding: 15px;
  }
  .table-turnos thead th.day-header:nth-child(n+7) { /* Sábado y Domingo */
    background-color: #e0f2fe; /* Azul claro para fines de semana */
    border-left: 2px solid #bfdbfe;
    border-right: 2px solid #bfdbfe;
  }
  .user-header { text-align: left !important; }
  .user-cell {
    font-weight: 700;
    color: #343a40;
    background-color: #f8f9fa;
  }
  .user-info-cell {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .user-info-cell small {
    font-size: 0.8em;
    color: #6c757d;
  }
  .table-turnos select {
    min-width: 120px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
  }
  .table-turnos select:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
  }
  .submit-container {
    position: sticky;
    bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    text-align: center;
    margin-top: 20px;
  }
</style>
{% endblock %}