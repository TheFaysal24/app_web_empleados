{% extends "base.html" %}
{% block title %}Asignar Turnos{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_asignar_turnos.css') }}">
{% endblock %}

{% block content %}
<div class="turnos-container">

  <!-- Navegación Superior -->
  <div class="top-nav">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">
      <i class="fas fa-arrow-left"></i> Volver al Dashboard
    </a>
    <h2 class="page-title">Asignación de Turnos</h2>
    <!-- Navegación de Semanas -->
    <div class="week-nav">
      <a href="{{ url_for('admin_asignar_turnos', semana_offset=semana_offset-1) }}" class="btn btn-info btn-sm">
        <i class="fas fa-chevron-left"></i> Semana Anterior
      </a>
      <span class="current-week">
        Semana del {{ inicio_semana.strftime('%d de %b') }} al {{ fin_semana.strftime('%d de %b, %Y') }}
      </span>
      <a href="{{ url_for('admin_asignar_turnos', semana_offset=semana_offset+1) }}" class="btn btn-info btn-sm">
        Semana Siguiente <i class="fas fa-chevron-right"></i>
      </a>
    </div>
  </div>

  <!-- Formulario principal -->
  <form method="POST" action="{{ url_for('admin_asignar_turnos') }}">
    {{ form.hidden_tag() }}
    <!-- Campo oculto para saber qué semana estamos guardando -->
    <input type="hidden" name="semana_offset" value="{{ semana_offset }}">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title text-gradient">
          <i class="fas fa-calendar-plus"></i> Planificación Semanal
        </h3>
        <p class="card-subtitle">
          Asigna, edita o corrige los turnos para cada usuario.
        </p>
      </div>

      <div class="table-responsive">
        <table class="table table-turnos">
          <thead>
            <tr>
              <th class="user-header">Usuario</th>
              {% for fecha in fechas_semana %}
                <th class="day-header">
                  {{ fecha.strftime('%A')|capitalize }}<br>
                  <small>{{ fecha.strftime('%d/%m') }}</small>
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for usuario in usuarios %}
            <tr>
              <td class="user-cell">
                <div class="user-info-cell">
                  <i class="fas fa-user-circle"></i>
                  <span>{{ usuario.nombre }}</span>
                  <small>{{ usuario.cargo }}</small>
                </div>
              </td>
              {% for fecha in fechas_semana %}
              <td>
                <div class="form-group-table">
                  <!-- El nombre del campo es `id_usuario-fecha` -->
                  <select name="{{ usuario.id }}-{{ fecha.isoformat() }}" class="form-control form-control-sm">
                    <option value="">-- Descanso --</option>
                    {% set turno_actual = turnos_asignados.get(usuario.id, {}).get(fecha.isoformat()) %}
                    {% for turno_disponible in turnos_disponibles %}
                      <option value="{{ turno_disponible.id }}" {% if turno_actual and turno_actual == turno_disponible.id %}selected{% endif %}>
                        {{ turno_disponible.hora }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </td>
              {% endfor %}
            </tr>
            {% else %}
            <tr>
              <td colspan="8" class="text-center p-3">No hay usuarios para mostrar.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Botón de Guardar Fijo -->
    <div class="submit-container">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="fas fa-save"></i> Guardar Cambios
      </button>
    </div>
  </form>
</div>
{% endblock %}