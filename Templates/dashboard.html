{% extends "base.html" %}
{% block title %}Dashboard Premium{% endblock %}
{% block content %}
<style>
  .dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .dashboard-header h2 {
    margin: 0;
    font-size: 2em;
    font-weight: 700;
  }

  .time-buttons-header {
    display: flex;
    gap: 10px;
  }

  .btn-small {
    border: none;
    color: white;
    padding: 10px 18px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  }

  .btn-inicio-small {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  }

  .btn-inicio-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    color: white;
    text-decoration: none;
  }

  .btn-salida-small {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
  }

  .btn-salida-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    color: white;
    text-decoration: none;
  }

  .stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border-left: 5px solid;
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-card h5 {
    margin: 0 0 10px 0;
    font-size: 0.85em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .stat-value {
    font-size: 2.2em;
    font-weight: 700;
    color: #667eea;
  }

  .stat-card.verde {
    border-left-color: #11998e;
  }

  .stat-card.rojo {
    border-left-color: #ff6b6b;
  }

  .stat-card.azul {
    border-left-color: #667eea;
  }

  .stat-card.naranja {
    border-left-color: #f59e0b;
  }

  .stat-card.morado {
    border-left-color: #a855f7;
  }

  .section-title {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3em;
  }

  .table-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
  }

  .table-card table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9em;
  }

  .table-card thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .table-card th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9em;
  }

  .table-card td {
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-card tbody tr:hover {
    background-color: #f8f9ff;
  }

  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .badge-success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .badge-warning {
    background: #fff3e0;
    color: #e65100;
  }

  .badge-info {
    background: #e3f2fd;
    color: #1565c0;
  }

  .badge-cost {
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    color: white;
    font-weight: 700;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
  }

  .chart-card h4 {
    color: #667eea;
    margin-top: 0;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .export-buttons {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-export-small {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-export-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    color: white;
    text-decoration: none;
  }

  .no-data {
    text-align: center;
    color: #999;
    padding: 20px;
    font-style: italic;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
  }

  .chart-value-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    font-size: 0.85em;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .dashboard-header {
      flex-direction: column;
      text-align: center;
      gap: 15px;
    }

    .time-buttons-header {
      justify-content: center;
      width: 100%;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .table-card table {
      font-size: 0.8em;
    }

    .table-card th, .table-card td {
      padding: 6px 5px;
    }
  }
</style>

<!-- Header con botones integrados -->
<div class="dashboard-header">
  <div>
    <h2>üìä Dashboard Administrativo</h2>
  </div>
  <div class="time-buttons-header">
    <form method="POST" action="{{ url_for('marcar_inicio') }}">
      <button type="submit" class="btn-small btn-inicio-small">
        <i class="fas fa-play"></i> Inicio
      </button>
    </form>
    <form method="POST" action="{{ url_for('marcar_salida') }}">
      <button type="submit" class="btn-small btn-salida-small">
        <i class="fas fa-stop"></i> Salida
      </button>
    </form>
  </div>
</div>

<!-- Tarjetas de estad√≠sticas -->
<div class="stat-cards-grid">
  <div class="stat-card verde">
    <h5>üë• Total Empleados</h5>
    <div class="stat-value">{{ total_usuarios_nuevos }}</div>
  </div>
  <div class="stat-card rojo">
    <h5>‚úÖ Iniciados Hoy</h5>
    <div class="stat-value">{{ usuarios_iniciados_hoy }}</div>
  </div>
  <div class="stat-card azul">
    <h5>üìã Total Registros</h5>
    <div class="stat-value">
      {% set total = namespace(count=0) %}
      {% for usr, regs in registros.items() %}
        {% for fecha, reg in regs.items() %}
          {% set total.count = total.count + 1 %}
        {% endfor %}
      {% endfor %}
      {{ total.count }}
    </div>
  </div>
  <div class="stat-card morado">
    <h5>üí∞ Costo Horas Extras</h5>
    <div class="stat-value" style="font-size: 1.8em;">$ {{ "{:,.0f}".format(costo_total_empresa) }}</div>
  </div>
</div>

<!-- Tabla de registros -->
<div class="table-card">
  <h3 class="section-title">üìã Registros de Asistencia por Usuario</h3>
  {% if registros %}
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Veces Iniciado</th>
            <th>√öltima Fecha</th>
            <th>Hora Inicio</th>
            <th>Hora Salida</th>
            <th>Horas Trabajadas</th>
            <th>Horas Extras</th>
            <th>üí∞ Costo Extras</th>
          </tr>
        </thead>
        <tbody>
          {% set row_count = namespace(count=0) %}
          {% for usr, regs in registros.items() %}
            {% set last_reg = regs.items()|list|last %}
            {% if last_reg %}
              <tr>
                <td><strong>{{ usr }}</strong></td>
                <td><span class="badge badge-success">{{ contador_inicios.get(usr, 0) }} veces</span></td>
                <td>{{ last_reg[0] }}</td>
                <td>{{ last_reg[1].inicio[11:16] if last_reg[1].inicio else '-' }}</td>
                <td>{{ last_reg[1].salida[11:16] if last_reg[1].salida else '-' }}</td>
                <td><span class="badge badge-success">{{ last_reg[1].horas_trabajadas }}h</span></td>
                <td><span class="badge badge-warning">{{ last_reg[1].horas_extras }}h</span></td>
                <td><span class="badge badge-cost">$ {{ "{:,.0f}".format(costo_horas_extras.get(usr, 0)) }}</span></td>
              </tr>
              {% set row_count.count = row_count.count + 1 %}
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="no-data">
      <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3;"></i>
      <p>No hay registros disponibles. Comienza a registrar turnos.</p>
    </div>
  {% endif %}
</div>

<!-- Gr√°ficos debajo de la tabla -->
<div class="grid-2">
  <div class="chart-card">
    <h4>üìà Horas Trabajadas (√öltimos 7 d√≠as)</h4>
    <canvas id="graficoHoras" style="max-height: 300px;"></canvas>
  </div>

  <div class="chart-card">
    <h4>üë§ Inicios por Usuario (% y Cantidad)</h4>
    <canvas id="graficoInicios" style="max-height: 300px;"></canvas>
  </div>
</div>

<!-- Botones de exportaci√≥n -->
<div class="export-buttons">
  <h5 style="width: 100%; margin: 0 0 10px 0; color: #667eea; font-weight: 700;">‚¨áÔ∏è Descargar Datos</h5>
  <a href="{{ url_for('exportar_registros') }}" class="btn-export-small">
    <i class="fas fa-download"></i> Registros CSV
  </a>
  <a href="{{ url_for('exportar_datos') }}" class="btn-export-small">
    <i class="fas fa-file-csv"></i> Datos Completos
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Plugin para mostrar valores en barras
  const chartDataLabels = {
    id: 'chartDataLabels',
    afterDatasetsDraw(chart) {
      chart.data.datasets.forEach((datasetMeta, i) => {
        const meta = chart.getDatasetMeta(i);
        meta.data.forEach((bar, index) => {
          const data = bar.$context.parsed.y;
          if (data > 0) {
            const ctx = chart.ctx;
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(data.toFixed(1), bar.x, bar.y - 5);
          }
        });
      });
    }
  };

  // Gr√°fico de horas
  const ctx1 = document.getElementById('graficoHoras');
  if (ctx1) {
    new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: {{ fechas|tojson }},
        datasets: [{
          label: 'Horas trabajadas',
          data: {{ horas_fechas|tojson }},
          backgroundColor: [
            '#667eea',
            '#764ba2',
            '#f093fb',
            '#f5576c',
            '#4facfe',
            '#00f2fe',
            '#fa709a'
          ],
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: '#667eea',
              font: { weight: 'bold', size: 11 }
            },
            grid: {
              color: 'rgba(102, 126, 234, 0.1)'
            }
          },
          x: {
            ticks: {
              color: '#667eea',
              font: { weight: 'bold', size: 11 }
            },
            grid: {
              display: false
            }
          }
        }
      },
      plugins: [chartDataLabels]
    });
  }

  // Gr√°fico de inicios por usuario
  const ctx2 = document.getElementById('graficoInicios');
  if (ctx2) {
    const contadores = {{ contador_inicios|tojson }};
    const usuarios = Object.keys(contadores);
    const inicios = Object.values(contadores);
    const totalInicios = inicios.reduce((a, b) => a + b, 0);
    const porcentajes = inicios.map(x => ((x / totalInicios) * 100).toFixed(1));

    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: usuarios.map((u, i) => u + ' (' + inicios[i] + ' veces, ' + porcentajes[i] + '%)'),
        datasets: [{
          data: inicios,
          backgroundColor: [
            '#667eea',
            '#764ba2',
            '#f093fb',
            '#f5576c',
            '#4facfe',
            '#00f2fe',
            '#fa709a',
            '#11998e',
            '#38ef7d'
          ],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 10, weight: 'bold' },
              color: '#667eea',
              padding: 8
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return value + ' inicios (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
