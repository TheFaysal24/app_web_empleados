{% block title %}Dashboard Premium{% endblock %}
{% block content %}
<style>
  body {
    background: #f5f7fa;
    padding: 20px;
  }

  .top-navigation {
    background: white;
    padding: 18px 30px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .nav-brand h3 {
    margin: 0;
    color: #0f2027;
    font-weight: 700;
    font-size: 1.4em;
  }

  .nav-brand .user-info {
    background: linear-gradient(135deg, #f0f7ff, #e0f2fe);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    color: #1e40af;
    font-weight: 600;
  }

  .nav-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-toggle {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    width: 48px;
    height: 48px;
    position: relative;
    overflow: hidden;
  }

  .dropdown-toggle::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
    transform: scale(0);
    transition: transform 0.5s ease;
  }

  .dropdown-toggle:hover::before {
    transform: scale(1);
  }

  .dropdown-toggle:hover {
    transform: translateY(-3px) rotate(90deg);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
  }

  .dropdown-toggle .hamburger {
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: all 0.3s ease;
  }

  .dropdown-toggle .hamburger span {
    width: 20px;
    height: 3px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s ease;
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(1) {
    transform: translateY(2px) rotate(45deg);
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(2) {
    opacity: 0;
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(3) {
    transform: translateY(-9px) rotate(-45deg);
  }

  .dropdown-menu {
    position: absolute;
    top: 115%;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 240px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
    border: 1px solid #e0e0e0;
    padding: 8px 0;
  }

  .dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-menu a,
  .dropdown-menu form {
    display: block;
  }

  .dropdown-item {
    padding: 10px 20px;
    color: #374151;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.95em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .dropdown-item i {
    width: 20px;
    text-align: center;
    color: #667eea;
    font-size: 0.95em;
  }

  .dropdown-item:hover {
    background: #e0f2fe;
    color: #0369a1;
  }

  .dropdown-item:hover i {
    color: #0369a1;
  }

  .menu-section {
    padding: 12px 20px 6px 20px;
    color: #9ca3af;
    font-size: 0.7em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .btn-action {
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    text-decoration: none;
  }

  .btn-inicio {
    background: linear-gradient(135deg, #10b981, #34d399);
  }

  .btn-inicio:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4);
    color: white;
  }

  .btn-salida {
    background: linear-gradient(135deg, #ef4444, #f87171);
  }

  .btn-salida:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(239, 68, 68, 0.4);
    color: white;
  }

  .btn-admin {
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
  }

  .btn-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(139, 92, 246, 0.4);
    color: white;
  }

  .btn-backup {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
  }

  .btn-backup:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(245, 158, 11, 0.4);
    color: white;
  }

  .btn-export {
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4);
    color: white;
  }

  .btn-logout {
    background: #6b7280;
  }

  .btn-logout:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(107, 114, 128, 0.4);
    background: #4b5563;
    color: white;
  }

  .btn-logout i {
    margin-right: 6px;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    color: white;
    padding: 25px 35px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  .dashboard-header h2 {
    margin: 0 0 8px 0;
    font-size: 2em;
    font-weight: 700;
  }

  .dashboard-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1em;
  }

  .stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border-left: 5px solid;
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-card h5 {
    margin: 0 0 8px 0;
    font-size: 0.75em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .stat-value {
    font-size: 1.8em;
    font-weight: 700;
    color: #667eea;
  }

  .stat-card.verde {
    border-left-color: #11998e;
  }

  .stat-card.rojo {
    border-left-color: #ff6b6b;
  }

  .stat-card.azul {
    border-left-color: #4facfe;
  }

  .stat-card.naranja {
    border-left-color: #f59e0b;
  }

  .stat-card.morado {
    border-left-color: #a855f7;
  }

  .section-title {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2em;
  }

  .table-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
  }

  .table-card table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9em;
  }

  .table-card thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .table-card th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9em;
  }

  .table-card td {
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-card tbody tr:hover {
    background-color: #f8f9ff;
  }

  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .badge-success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .badge-warning {
    background: #fff3e0;
    color: #e65100;
  }

  .badge-info {
    background: #e3f2fd;
    color: #1565c0;
  }

  .badge-cost {
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    color: white;
    font-weight: 700;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
  }

  .chart-card h4 {
    color: #667eea;
    margin-top: 0;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .export-buttons {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-export-small {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-export-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
    text-decoration: none;
  }

  .no-data {
    text-align: center;
    color: #999;
    padding: 20px;
    font-style: italic;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
  }

  .chart-value-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    font-size: 0.85em;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .top-navigation {
      flex-direction: column;
      gap: 15px;
    }

    .nav-actions {
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .btn-action {
      flex: 1 1 auto;
      min-width: 120px;
    }

    .dashboard-header {
      padding: 25px;
      text-align: center;
    }

    .dashboard-header h2 {
      font-size: 1.8em;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .table-card table {
      font-size: 0.8em;
    }

    .table-card th, .table-card td {
      padding: 6px 5px;
    }
  }
</style>

<!-- NavegaciÃ³n Superior -->
<div class="top-navigation">
  <div class="nav-brand">
    <h3><i class="fas fa-users-cog"></i> Sistema de Empleados</h3>
    <span class="user-info">
      <i class="fas fa-user-circle"></i> {{ nombre }}
    </span>
  </div>
  <div class="nav-actions">
    {% if not admin %}
    <form method="POST" action="{{ url_for('marcar_inicio') }}" style="display: inline;">
      <button type="submit" class="btn-action btn-inicio">
        <i class="fas fa-play-circle"></i> Inicio
      </button>
    </form>
    <form method="POST" action="{{ url_for('marcar_salida') }}" style="display: inline;">
      <button type="submit" class="btn-action btn-salida">
        <i class="fas fa-stop-circle"></i> Salida
      </button>
    </form>
    {% endif %}
    
    <a href="{{ url_for('logout') }}" class="btn-action btn-logout">
      <i class="fas fa-right-from-bracket"></i> Salir
    </a>
    
    <!-- MenÃº Desplegable Elegante -->
    <div class="dropdown">
      <button class="dropdown-toggle">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
      <div class="dropdown-menu">
        <div class="menu-section">PRINCIPAL</div>
        <a href="{{ url_for('dashboard') }}" class="dropdown-item">
          <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="{{ url_for('modulo_turnos') }}" class="dropdown-item">
          <i class="fas fa-people-group"></i> GestiÃ³n de Turnos
        </a>
        <a href="{{ url_for('ajustes') }}" class="dropdown-item">
          <i class="fas fa-cog"></i> Ajustes
        </a>
        <a href="{{ url_for('seleccionar_turno') }}" class="dropdown-item">
          <i class="fas fa-calendar-clock"></i> Seleccionar Turno
        </a>
        <a href="{{ url_for('ver_turnos_asignados') }}" class="dropdown-item">
          <i class="fas fa-calendar-check"></i> Ver Mis Turnos
        </a>

        {% if admin %}
        <div class="menu-section" style="margin-top: 8px;">ADMINISTRACIÃ“N</div>
        <a href="{{ url_for('admin_asignar_turnos') }}" class="dropdown-item">
          <i class="fas fa-user-cog"></i> Asignar Turnos
        </a>
        <a href="{{ url_for('admin_usuarios') }}" class="dropdown-item">
          <i class="fas fa-users-cog"></i> GestiÃ³n de Usuarios
        </a>
        <a href="{{ url_for('admin_backups') }}" class="dropdown-item">
          <i class="fas fa-database"></i> Backups
        </a>
        <a href="{{ url_for('exportar_registros') }}" class="dropdown-item">
          <i class="fas fa-file-download"></i> Exportar a CSV
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Header -->
<div class="dashboard-header">
  <div>
    <h2>{% if admin %}ðŸ‘‘ Panel de GestiÃ³n Ejecutiva{% else %}ðŸ“Š Mi Panel de Control{% endif %}</h2>
    <p>{% if admin %}Centro de comando y control del sistema{% else %}Control de asistencia y gestiÃ³n personal{% endif %}</p>
  </div>
</div>

<!-- Acceso RÃ¡pido (Usuarios) -->
{% if not admin %}
<div class="table-card">
  <h3 class="section-title"><i class="fas fa-th-large"></i> Acceso RÃ¡pido a MÃ³dulos</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
    <a href="{{ url_for('modulo_turnos') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-people-group" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      <div style="font-size: 0.9em;">GestiÃ³n de Turnos</div>
    </a>
    <a href="{{ url_for('seleccionar_turno') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-calendar-clock" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      <div style="font-size: 0.9em;">Seleccionar Turno</div>
    </a>
    <a href="{{ url_for('ver_turnos_asignados') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-calendar-check" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      <div style="font-size: 0.9em;">Mis Turnos</div>
    </a>
    <a href="{{ url_for('ajustes') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-gear" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      <div style="font-size: 0.9em;">Mi Perfil</div>
    </a>
  </div>
</div>
{% endif %}

<!-- Acciones RÃ¡pidas Admin -->
{% if admin %}
<div class="table-card">
  <h3 class="section-title">
    <i class="fas fa-tools"></i> Centro de Control Administrativo
  </h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
    <a href="{{ url_for('admin_asignar_turnos') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-user-cog" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      Asignar Turnos
    </a>
    <a href="{{ url_for('admin_usuarios') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-users" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      Gestionar Usuarios
    </a>
    <a href="{{ url_for('admin_backups') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-database" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      Backups
    </a>
    <a href="{{ url_for('exportar_registros') }}" style="background-color: #0d6efd; color: white; padding: 15px; border-radius: 10px; text-decoration: none; font-weight: 600; text-align: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);" onmouseover="this.style.backgroundColor='#0b5ed7'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 18px rgba(13, 110, 253, 0.4)'" onmouseout="this.style.backgroundColor='#0d6efd'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(13, 110, 253, 0.3)'">
      <i class="fas fa-file-download" style="font-size: 1.8em; display: block; margin-bottom: 10px;"></i>
      Exportar CSV
    </a>
  </div>
</div>
{% endif %}

<!-- Tarjetas de estadÃ­sticas -->
<div class="stat-cards-grid">
  <div class="stat-card verde">
    <h5>{% if admin %}ðŸ‘¥ Total Empleados{% else %}ðŸ‘¤ Mi Perfil{% endif %}</h5>
    <div class="stat-value">{{ total_usuarios_nuevos }}</div>
  </div>
  <div class="stat-card rojo">
    <h5>âœ… Iniciados Hoy</h5>
    <div class="stat-value">{{ usuarios_iniciados_hoy }}</div>
  </div>
  <div class="stat-card azul">
    <h5>ðŸ“‹ Total Registros</h5>
    <div class="stat-value">
      {% set total = namespace(count=0) %}
      {% for usr, regs in registros.items() %}
        {% for fecha, reg in regs.items() %}
          {% set total.count = total.count + 1 %}
        {% endfor %}
      {% endfor %}
      {{ total.count }}
    </div>
  </div>
  {% if admin %}
  <div class="stat-card morado">
    <h5>ðŸ’° Costo Horas Extras</h5>
    <div class="stat-value" style="font-size: 1.8em;">$ {{ "{:,.0f}".format(costo_total_empresa) }}</div>
  </div>
  {% endif %}
</div>

<!-- Tabla de registros -->
<div class="table-card">
  <h3 class="section-title"><i class="fas fa-clipboard-list"></i> Control de Asistencia</h3>
  {% if registros %}
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Veces Iniciado</th>
            <th>Ãšltima Fecha</th>
            <th>Hora Inicio</th>
            <th>Hora Salida</th>
            <th>Horas Trabajadas</th>
            <th>Horas Extras</th>
            {% if admin %}<th>ðŸ’° Costo Extras</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% set row_count = namespace(count=0) %}
          {% for usr, regs in registros.items() %}
            {% if regs and regs is mapping %}
            {% set last_reg = regs.items()|list|last %}
            {% if last_reg and last_reg|length == 2 and last_reg[1] is mapping %}
              <tr>
                <td><strong>{{ usr }}</strong></td>
                <td><span class="badge badge-success">{{ contador_inicios.get(usr, 0) if contador_inicios else 0 }} veces</span></td>
                <td>{{ last_reg[0] }}</td>
                <td>{{ last_reg[1].get('inicio', '')[:16][11:] if last_reg[1].get('inicio') else '-' }}</td>
                <td>{{ last_reg[1].get('salida', '')[:16][11:] if last_reg[1].get('salida') else '-' }}</td>
                <td><span class="badge badge-success" style="background: #e8f5ff; color: #0ea5e9; font-weight: 700;">{{ last_reg[1].get('horas_trabajadas', 0) }}h</span></td>
                <td><span class="badge badge-warning" style="background: #fff7ed; color: #f97316; font-weight: 700;">{{ last_reg[1].get('horas_extras', 0) }}h</span></td>
                {% if admin %}<td><span class="badge badge-cost">$ {{ "{:,.0f}".format(costo_horas_extras.get(usr, 0) if costo_horas_extras else 0) }}</span></td>{% endif %}
              </tr>
              {% set row_count.count = row_count.count + 1 %}
            {% endif %}
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="no-data">
      <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3;"></i>
      <p>No hay registros disponibles. Comienza a registrar turnos.</p>
    </div>
  {% endif %}
</div>

<!-- Resumen Semanal de Turnos -->
<div class="table-card">
  <h3 class="section-title">
    <i class="fas fa-calendar-week"></i> Resumen Semanal - Turnos por Gestor
    {% if admin %}
    <a href="{{ url_for('admin_asignar_turnos') }}" style="float: right; background: linear-gradient(135deg, #10b981, #34d399); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-size: 0.85em; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
      <i class="fas fa-user-cog"></i> Asignar Turnos
    </a>
    {% endif %}
  </h3>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <tr>
          <th style="padding: 12px; text-align: left;">Gestor</th>
          {% set dias_semana_map = {'monday': 'Lunes', 'tuesday': 'Martes', 'wednesday': 'MiÃ©rcoles', 'thursday': 'Jueves', 'friday': 'Viernes', 'saturday': 'SÃ¡bado', 'sunday': 'Domingo'} %}
          {% for fecha in fechas_semana_actual %}
            <th style="padding: 12px; text-align: center;">{{ dias_semana_map.get(fecha.strftime('%A').lower(), '') }}<br><small style="font-weight: normal; opacity: 0.8;">{{ fecha.strftime('%d/%m') }}</small></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for username, turnos_del_usuario in turnos_semana_actual.items() %}
          <tr style="border-bottom: 1px solid #e0e0e0;">
            <td style="padding: 12px; font-weight: 700;">{{ username }}</td>
            {% for fecha in fechas_semana_actual %}
              <td style="padding: 12px; text-align: center;">
                {% set dia_str = fecha.strftime('%A').lower() %}
                {% set hora_asignada = turnos_del_usuario.get(dia_str) %}
                {% if hora_asignada %}
                  <span class="badge badge-success">{{ hora_asignada }}</span>
                {% else %}
                  <span style="color: #ccc;">-</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-2">
  <div class="chart-card">
    <h4>ðŸ‘¥ DistribuciÃ³n de Turnos</h4>
    <canvas id="graficoInicios" style="max-height: 300px;"></canvas>
  </div>

</div>
{% if admin %}
<div class="export-buttons">
  <a href="{{ url_for('exportar_registros') }}" class="btn-export-small">
    <i class="fas fa-download"></i> Registros CSV
  </a>
</div>
{% endif %}

<!-- Variables de datos del servidor -->
<script type="text/javascript">
  var serverData = {
    fechas: {{ fechas|default([])|tojson|safe }},
    horas: {{ horas_fechas|default([])|tojson|safe }},
    contadores: {{ contador_inicios|default({})|tojson|safe }}
    {% if admin %},
    costos: {{ costo_horas_extras|default({})|tojson|safe }},
    usuarios: {{ data.get('usuarios', {})|tojson|safe }}
    {% endif %}
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    
    const chartDataLabels = {
      id: 'chartDataLabels',
      afterDatasetsDraw(chart) {
        chart.data.datasets.forEach((datasetMeta, i) => {
          const meta = chart.getDatasetMeta(i);
          meta.data.forEach((bar, index) => {
            const barData = bar.$context.parsed.y;
            if (barData > 0) {
              const ctx = chart.ctx;
              ctx.fillStyle = 'rgba(0,0,0,0.7)';
              ctx.font = 'bold 11px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(barData.toFixed(1), bar.x, bar.y - 5);
            }
          });
        });
      }
    };

    const ctx1 = document.getElementById('graficoHoras');
    if (ctx1 && serverData.fechas && serverData.horas) {
      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: serverData.fechas,
          datasets: [{
            label: 'Horas trabajadas',
            data: serverData.horas,
            backgroundColor: [
              '#667eea',
              '#764ba2',
              '#f093fb',
              '#f5576c',
              '#667eea',
              '#764ba2',
              '#fa709a'
            ],
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    const ctx2 = document.getElementById('graficoInicios');
    if (ctx2 && serverData.contadores && Object.keys(serverData.contadores).length > 0) {
      const usuarios = Object.keys(serverData.contadores);
      const inicios = Object.values(serverData.contadores);
      const totalInicios = inicios.reduce((a, b) => a + b, 0);
      const porcentajes = inicios.map(x => ((x / totalInicios) * 100).toFixed(1));

      // Crear datos combinados para mostrar en el grÃ¡fico
      const combinedData = usuarios.map((u, i) => ({
        usuario: u,
        inicios: inicios[i],
        porcentaje: porcentajes[i]
      }));

      // Ordenar por cantidad de inicios descendente
      combinedData.sort((a, b) => b.inicios - a.inicios);

      // Tomar solo los top 5 para mejor visualizaciÃ³n
      const topData = combinedData.slice(0, 5);cios);
      const topPorcentajes = topData.map(d => d.porcentaje);

      new Chart(ctx2, {
        type: 'bar',
        data: {
          label
            lab
            backgroundColor: [
              '#667eea', // Azul
              '#764ba2', // Morado
            ],
            borderRadius: 8,d: false,
            borderWidth: 0
          }]
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return value + ' inicios (' + percentage + '%)';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 },
                stepSize: 1
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    // GrÃ¡fico de costos de horas extras
    const ctx3 = document.getElementById('graficoCostos');
    if (ctx3 && serverData.costos && Object.keys(serverData.costos).length > 0) {
      const usuariosCostos = Object.keys(serverData.costos);
      const valoresCostos = Object.values(serverData.costos);

      // Filtrar solo valores mayores a 0
      const datosFiltrados = usuariosCostos.map((u, i) => ({
        usuario: u,
        costo: valoresCostos[i]
      })).filter(d => d.costo > 0);

      // Ordenar por costo descendente
      datosFiltrados.sort((a, b) => b.costo - a.costo);

      // Tomar top 5
      const topCostos = datosFiltrados.slice(0, 5);

      new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: topCostos.map(d => d.usuario),
          datasets: [{
            label: 'Costo Horas Extras ($)',
            data: topCostos.map(d => d.costo),
            backgroundColor: [
              '#ff6b6b', // Rojo
              '#f093fb', // Rosa claro
              '#667eea', // Azul
              '#fa709a', // Rosa oscuro
              '#11998e'  // Verde azulado
            ].slice(0, topCostos.length),
            borderRadius: 8,
            borderSkipped: false,
            borderWidth: 0
          }]
        },n
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 },
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    // GrÃ¡fico de distribuciÃ³n de cargos
    const ctx4 = document.getElementById('graficoCargos');
    if (ctx4 && serverData.usuarios) {
      const cargosCount = {};
      Object.values(serverData.usuarios).forEach(user => {
        const cargo = user.cargo || 'Sin definir';
        cargosCount[cargo] = (cargosCount[cargo] || 0) + 1;
      });

      const cargos = Object.keys(cargosCount);
      const cantidades = Object.values(cargosCount);

      new Chart(ctx4, {
        type: 'pie',
        data: {
          labels: cargos, // Solo el nombre del cargo
          datasets: [{
            data: cantidades,
            backgroundColor: [
              '#667eea', // Azul
              '#764ba2', // Morado
              '#f093fb', // Rosa claro
              '#f5576c', // Rojo coral
              '#667eea', // Azul (repetido para mÃ¡s categorÃ­as)
              '#764ba2',
              '#fa709a',
              '#11998e',
              '#38ef7d'
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {'bottom',
              labels: {
                font: { size: 10, weight: 'bold' },
                color: '#667eea',
                padding: 8
              },
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1); // Mostrar porcentaje en tooltip
                  return value + ' empleados (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }

  });
</script>
{% endblock %}
