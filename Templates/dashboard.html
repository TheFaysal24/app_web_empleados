{% extends "base.html" %}
{% block title %}Dashboard Premium{% endblock %}
{% block content %}
<style>
  body {
    background: #f5f7fa;
    padding: 20px;
  }

  .top-navigation {
    background: white;
    padding: 18px 30px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .nav-brand h3 {
    margin: 0;
    color: #0f2027;
    font-weight: 700;
    font-size: 1.4em;
  }

  .nav-brand .user-info {
    background: linear-gradient(135deg, #f0f7ff, #e0f2fe);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    color: #1e40af;
    font-weight: 600;
  }

  .nav-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-toggle {
    background: linear-gradient(135deg, #6b7280, #9ca3af);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .dropdown-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(107, 114, 128, 0.4);
  }

  .dropdown-toggle i:last-child {
    font-size: 0.75em;
    transition: transform 0.3s ease;
  }

  .dropdown:hover .dropdown-toggle i:last-child {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: 115%;
    right: 0;
    background: white;
    border-radius: 15px;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.25);
    min-width: 260px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-15px);
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    z-index: 1000;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-menu a,
  .dropdown-menu form {
    display: block;
  }

  .dropdown-item {
    padding: 14px 22px;
    color: #333;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.25s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95em;
  }

  .dropdown-item:first-child {
    border-radius: 15px 15px 0 0;
  }

  .dropdown-item:last-child {
    border-radius: 0 0 15px 15px;
  }

  .dropdown-item:hover {
    background: linear-gradient(90deg, #f0f9ff, #e0f2fe);
    padding-left: 28px;
    color: #1e40af;
  }

  .dropdown-item i {
    width: 24px;
    text-align: center;
    font-size: 1.1em;
  }

  .menu-section {
    padding: 8px 22px;
    color: #9ca3af;
    font-size: 0.75em;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .btn-action {
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    text-decoration: none;
  }

  .btn-inicio {
    background: linear-gradient(135deg, #10b981, #34d399);
  }

  .btn-inicio:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(16, 185, 129, 0.4);
    color: white;
  }

  .btn-salida {
    background: linear-gradient(135deg, #ef4444, #f87171);
  }

  .btn-salida:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(239, 68, 68, 0.4);
    color: white;
  }

  .btn-admin {
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
  }

  .btn-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(139, 92, 246, 0.4);
    color: white;
  }

  .btn-backup {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
  }

  .btn-backup:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(245, 158, 11, 0.4);
    color: white;
  }

  .btn-export {
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4);
    color: white;
  }

  .btn-logout {
    background: linear-gradient(135deg, #6b7280, #9ca3af);
  }

  .btn-logout:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(107, 114, 128, 0.4);
    color: white;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  }

  .dashboard-header h2 {
    margin: 0 0 10px 0;
    font-size: 2.5em;
    font-weight: 700;
  }

  .dashboard-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1em;
  }

  .stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border-left: 5px solid;
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-card h5 {
    margin: 0 0 10px 0;
    font-size: 0.85em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .stat-value {
    font-size: 2.2em;
    font-weight: 700;
    color: #667eea;
  }

  .stat-card.verde {
    border-left-color: #11998e;
  }

  .stat-card.rojo {
    border-left-color: #ff6b6b;
  }

  .stat-card.azul {
    border-left-color: #667eea;
  }

  .stat-card.naranja {
    border-left-color: #f59e0b;
  }

  .stat-card.morado {
    border-left-color: #a855f7;
  }

  .section-title {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3em;
  }

  .table-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
  }

  .table-card table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9em;
  }

  .table-card thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .table-card th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9em;
  }

  .table-card td {
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-card tbody tr:hover {
    background-color: #f8f9ff;
  }

  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .badge-success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .badge-warning {
    background: #fff3e0;
    color: #e65100;
  }

  .badge-info {
    background: #e3f2fd;
    color: #1565c0;
  }

  .badge-cost {
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    color: white;
    font-weight: 700;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
  }

  .chart-card h4 {
    color: #667eea;
    margin-top: 0;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .export-buttons {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(102, 126, 234, 0.1);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-export-small {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(79, 172, 254, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-export-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
    color: white;
    text-decoration: none;
  }

  .no-data {
    text-align: center;
    color: #999;
    padding: 20px;
    font-style: italic;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
  }

  .chart-value-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    font-size: 0.85em;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .top-navigation {
      flex-direction: column;
      gap: 15px;
    }

    .nav-actions {
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .btn-action {
      flex: 1 1 auto;
      min-width: 120px;
    }

    .dashboard-header {
      padding: 25px;
      text-align: center;
    }

    .dashboard-header h2 {
      font-size: 1.8em;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .table-card table {
      font-size: 0.8em;
    }

    .table-card th, .table-card td {
      padding: 6px 5px;
    }
  }
</style>

<!-- Navegaci√≥n Superior -->
<div class="top-navigation">
  <div class="nav-brand">
    <h3><i class="fas fa-users-cog"></i> Sistema de Empleados</h3>
    <span class="user-info">
      <i class="fas fa-user-circle"></i> {{ nombre }}
    </span>
  </div>
  <div class="nav-actions">
    <form method="POST" action="{{ url_for('marcar_inicio') }}" style="display: inline;">
      <button type="submit" class="btn-action btn-inicio">
        <i class="fas fa-play-circle"></i> Inicio
      </button>
    </form>
    <form method="POST" action="{{ url_for('marcar_salida') }}" style="display: inline;">
      <button type="submit" class="btn-action btn-salida">
        <i class="fas fa-stop-circle"></i> Salida
      </button>
    </form>
    
    <!-- Men√∫ Desplegable -->
    <div class="dropdown">
      <button class="dropdown-toggle">
        <i class="fas fa-bars"></i> Men√∫ <i class="fas fa-chevron-down"></i>
      </button>
      <div class="dropdown-menu">
        <div class="menu-section">Principal</div>
        <a href="{{ url_for('dashboard') }}" class="dropdown-item">
          <i class="fas fa-home"></i> Dashboard
        </a>
        <a href="{{ url_for('modulo_turnos') }}" class="dropdown-item">
          <i class="fas fa-calendar-week"></i> M√≥dulo de Turnos
        </a>
        <a href="{{ url_for('ajustes') }}" class="dropdown-item">
          <i class="fas fa-cog"></i> Ajustes
        </a>
        <a href="{{ url_for('seleccionar_turno') }}" class="dropdown-item">
          <i class="fas fa-calendar-plus"></i> Seleccionar Turno
        </a>
        <a href="{{ url_for('ver_turnos_asignados') }}" class="dropdown-item">
          <i class="fas fa-calendar-check"></i> Ver Mis Turnos
        </a>

        {% if admin %}
        <div class="menu-section" style="margin-top: 10px;">Administraci√≥n</div>
        <a href="{{ url_for('admin_usuarios') }}" class="dropdown-item">
          <i class="fas fa-users"></i> Gesti√≥n de Usuarios
        </a>
        <a href="{{ url_for('admin_backups') }}" class="dropdown-item">
          <i class="fas fa-database"></i> Backups
        </a>
        <a href="{{ url_for('exportar_registros') }}" class="dropdown-item">
          <i class="fas fa-file-download"></i> Exportar a CSV
        </a>
        {% endif %}
      </div>
    </div>
    
    <a href="{{ url_for('logout') }}" class="btn-action btn-logout">
      <i class="fas fa-sign-out-alt"></i> Salir
    </a>
  </div>
</div>

<!-- Header -->
<div class="dashboard-header">
  <div>
    <h2>{% if admin %}üëë Panel Administrativo{% else %}üìä Mi Dashboard{% endif %}</h2>
    <p>Control de asistencia y gesti√≥n de personal</p>
  </div>
</div>

<!-- Tarjetas de estad√≠sticas -->
<div class="stat-cards-grid">
  <div class="stat-card verde">
    <h5>{% if admin %}üë• Total Empleados{% else %}üë§ Mi Perfil{% endif %}</h5>
    <div class="stat-value">{{ total_usuarios_nuevos }}</div>
  </div>
  <div class="stat-card rojo">
    <h5>‚úÖ Iniciados Hoy</h5>
    <div class="stat-value">{{ usuarios_iniciados_hoy }}</div>
  </div>
  <div class="stat-card azul">
    <h5>üìã Total Registros</h5>
    <div class="stat-value">
      {% set total = namespace(count=0) %}
      {% for usr, regs in registros.items() %}
        {% for fecha, reg in regs.items() %}
          {% set total.count = total.count + 1 %}
        {% endfor %}
      {% endfor %}
      {{ total.count }}
    </div>
  </div>
  {% if admin %}
  <div class="stat-card morado">
    <h5>üí∞ Costo Horas Extras</h5>
    <div class="stat-value" style="font-size: 1.8em;">$ {{ "{:,.0f}".format(costo_total_empresa) }}</div>
  </div>
  {% endif %}
</div>

<!-- Tabla de registros -->
<div class="table-card">
  <h3 class="section-title">üìã Registros de Asistencia por Usuario</h3>
  {% if registros %}
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Veces Iniciado</th>
            <th>√öltima Fecha</th>
            <th>Hora Inicio</th>
            <th>Hora Salida</th>
            <th>Horas Trabajadas</th>
            {% if admin %}
            <th>Horas Extras</th>
            <th>üí∞ Costo Extras</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% set row_count = namespace(count=0) %}
          {% for usr, regs in registros.items() %}
            {% set last_reg = regs.items()|list|last %}
            {% if last_reg %}
              <tr>
                <td><strong>{{ usr }}</strong></td>
                <td><span class="badge badge-success">{{ contador_inicios.get(usr, 0) }} veces</span></td>
                <td>{{ last_reg[0] }}</td>
                <td>{{ last_reg[1].inicio[11:16] if last_reg[1].inicio else '-' }}</td>
                <td>{{ last_reg[1].salida[11:16] if last_reg[1].salida else '-' }}</td>
                <td><span class="badge badge-success">{{ last_reg[1].horas_trabajadas }}h</span></td>
                {% if admin %}
                <td><span class="badge badge-warning">{{ last_reg[1].horas_extras }}h</span></td>
                <td><span class="badge badge-cost">$ {{ "{:,.0f}".format(costo_horas_extras.get(usr, 0)) }}</span></td>
                {% endif %}
              </tr>
              {% set row_count.count = row_count.count + 1 %}
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="no-data">
      <i class="fas fa-inbox" style="font-size: 3em; opacity: 0.3;"></i>
      <p>No hay registros disponibles. Comienza a registrar turnos.</p>
    </div>
  {% endif %}
</div>

<!-- Tabla de turnos asignados -->
<div class="table-card">
  <h3 class="section-title">üìÖ Turnos Asignados - {{ "Mes Actual" }}</h3>
  {% set turnos_data = namespace(shifts={}) %}
  {% if data and data.get('turnos') and data.get('turnos').get('monthly_assignments') %}
  {% for usr, assignments in data['turnos']['monthly_assignments'].items() %}
    {% if assignments and (admin or usr == session.get('usuario')) %}
      {% for turno_key in assignments %}
        {% set dia, hora = turno_key.split('_') %}
        {% if usr not in turnos_data.shifts %}
          {% set turnos_data.shifts = turnos_data.shifts.update({usr: []}) %}
        {% endif %}
        {% set _ = turnos_data.shifts[usr].append({'dia': dia, 'hora': hora}) %}
      {% endfor %}
    {% endif %}
  {% endfor %}
  {% endif %}
  {% if turnos_data.shifts %}
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Usuario</th>
            <th>D√≠a</th>
            <th>Hora</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for usr, shifts_list in turnos_data.shifts.items() %}
            {% for shift in shifts_list %}
              <tr>
                <td><strong>{{ usr }}</strong></td>
                <td>{{ shift.dia.title() }}</td>
                <td>{{ shift.hora }}</td>
                <td><span class="badge badge-info">Asignado</span></td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="no-data">
      <i class="fas fa-calendar-times" style="font-size: 3em; opacity: 0.3;"></i>
      <p>No hay turnos asignados en el mes actual.</p>
    </div>
  {% endif %}
</div>

<!-- Gr√°ficos debajo de la tabla -->
<div class="grid-2">
  <div class="chart-card">
    <h4>üìà Horas Trabajadas (√öltimos 7 d√≠as)</h4>
    <canvas id="graficoHoras" style="max-height: 300px;"></canvas>
  </div>

  <div class="chart-card">
    <h4>üë§ Inicios por Usuario (% y Cantidad)</h4>
    <canvas id="graficoInicios" style="max-height: 300px;"></canvas>
  </div>
</div>

<!-- Botones de exportaci√≥n -->
<div class="export-buttons">
  <h5 style="width: 100%; margin: 0 0 10px 0; color: #667eea; font-weight: 700;">‚¨áÔ∏è Descargar Datos</h5>
  <a href="{{ url_for('exportar_registros') }}" class="btn-export-small">
    <i class="fas fa-download"></i> Registros CSV
  </a>
  <a href="{{ url_for('exportar_datos') }}" class="btn-export-small">
    <i class="fas fa-file-csv"></i> Datos Completos
  </a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  /* eslint-disable */
  // Plugin para mostrar valores en barras
  const chartDataLabels = {
    id: 'chartDataLabels',
    afterDatasetsDraw(chart) {
      chart.data.datasets.forEach((datasetMeta, i) => {
        const meta = chart.getDatasetMeta(i);
        meta.data.forEach((bar, index) => {
          const data = bar.$context.parsed.y;
          if (data > 0) {
            const ctx = chart.ctx;
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(data.toFixed(1), bar.x, bar.y - 5);
          }
        });
      });
    }
  };

  // Gr√°fico de horas
    const chartLabels = {{ fechas|default([])|tojson|safe }};
    const horasData = {{ horas_fechas|default([])|tojson|safe }};
    const ctx1 = document.getElementById('graficoHoras');
    if (ctx1) {
      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Horas trabajadas',
            data: horasData,
            backgroundColor: [
              '#667eea',
              '#764ba2',
              '#f093fb',
              '#f5576c',
              '#4facfe',
              '#00f2fe',
              '#fa709a'
            ],
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

  // Gr√°fico de inicios por usuario
  const ctx2 = document.getElementById('graficoInicios');
  if (ctx2) {
    const contadores = {{ contador_inicios|default({})|tojson|safe }};
    const usuarios = Object.keys(contadores);
    const inicios = Object.values(contadores);
    const totalInicios = inicios.reduce((a, b) => a + b, 0);
    const porcentajes = inicios.map(x => ((x / totalInicios) * 100).toFixed(1));

    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels: usuarios.map((u, i) => u + ' (' + inicios[i] + ' veces, ' + porcentajes[i] + '%)'),
        datasets: [{
          data: inicios,
          backgroundColor: [
            '#667eea',
            '#764ba2',
            '#f093fb',
            '#f5576c',
            '#4facfe',
            '#00f2fe',
            '#fa709a',
            '#11998e',
            '#38ef7d'
          ],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 10, weight: 'bold' },
              color: '#667eea',
              padding: 8
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return value + ' inicios (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }
</script>
{% endblock %}
