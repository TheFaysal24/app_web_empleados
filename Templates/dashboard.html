{% block title %}Dashboard Premium{% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='custom_buttons.css') }}">
<style>
  body {
    background: #f5f7fa;
    padding: 20px;
  }

  .top-navigation {
    background: white;
    padding: 18px 30px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .nav-brand h3 {
    margin: 0;
    color: #0f2027;
    font-weight: 700;
    font-size: 1.4em;
  }

  .nav-brand .user-info {
    background: linear-gradient(135deg, #f0f7ff, #e0f2fe);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    color: #1e40af;
    font-weight: 600;
    /* Asegurar que no muestre texto largo por error */
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .nav-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .dropdown {
    position: relative;
  }

  .dropdown-toggle {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: 600;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    width: 48px;
    height: 48px;
    position: relative;
    overflow: hidden;
  }

  .dropdown-toggle::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
    transform: scale(0);
    transition: transform 0.5s ease;
  }

  .dropdown-toggle:hover::before {
    transform: scale(1);
  }

  .dropdown-toggle:hover {
    transform: translateY(-3px) rotate(90deg);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
  }

  .dropdown-toggle .hamburger {
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: all 0.3s ease;
  }

  .dropdown-toggle .hamburger span {
    width: 20px;
    height: 3px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s ease;
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(1) {
    transform: translateY(2px) rotate(45deg);
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(2) {
    opacity: 0;
  }

  .dropdown:hover .dropdown-toggle .hamburger span:nth-child(3) {
    transform: translateY(-9px) rotate(-45deg);
  }

  .dropdown-menu {
    position: absolute;
    top: 115%;
    right: 0;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 240px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    z-index: 1000;
    border: 1px solid #e0e0e0;
    padding: 8px 0;
  }

  .dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-menu a,
  .dropdown-menu form {
    display: block;
  }

  .dropdown-item {
    padding: 10px 20px;
    color: #374151;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.95em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .dropdown-item i {
    width: 20px;
    text-align: center;
    color: #667eea;
    font-size: 0.95em;
  }

  .dropdown-item:hover {
    background: #e0f2fe;
    color: #0369a1;
  }

  .dropdown-item:hover i {
    color: #0369a1;
  }

  .menu-section {
    padding: 12px 20px 6px 20px;
    color: #9ca3af;
    font-size: 0.7em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .btn-action {
    border: none;
    color: white;
    padding: 8px 16px; /* MÃ¡s pequeÃ±o y compacto */
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85em; /* Fuente mÃ¡s pequeÃ±a */
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    text-decoration: none;
  }

  .btn-turnos {
    background: linear-gradient(to right, #2563eb, #3b82f6) !important; /* Azul Real */
  }
  .btn-turnos:hover {
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4) !important;
    transform: translateY(-2px);
  }

  /* Colores especÃ­ficos para botones pequeÃ±os de navegaciÃ³n */
  .btn-nav-small {
    background: white;
    color: #4b5563;
    border: 1px solid #e5e7eb;
  }
  .btn-nav-small:hover {
    background: #f9fafb;
    color: #1f2937;
  }

  .btn-inicio {
    background: linear-gradient(to right, #11998e, #38ef7d) !important;
  }

  .btn-inicio:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(56, 239, 125, 0.4) !important;
    color: white !important;
  }

  .btn-salida {
    background: linear-gradient(to right, #cb2d3e, #ef473a) !important;
  }

  .btn-salida:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(239, 71, 58, 0.4) !important;
    color: white !important;
  }

  .btn-admin {
    background: linear-gradient(to right, #8E2DE2, #4A00E0) !important;
  }

  .btn-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(74, 0, 224, 0.4) !important;
    color: white !important;
  }

  .btn-backup {
    background: linear-gradient(to right, #F2994A, #F2C94C) !important;
  }

  .btn-backup:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(242, 201, 76, 0.4) !important;
    color: white !important;
  }

  .btn-export {
    background: linear-gradient(to right, #00c6ff, #0072ff) !important;
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0, 114, 255, 0.4) !important;
    color: white !important;
  }

  .btn-logout {
    background: #6b7280;
  }

  .btn-logout:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(107, 114, 128, 0.4);
    background: #4b5563;
    color: white;
  }

  .btn-logout i {
    margin-right: 6px;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
    color: white;
    padding: 25px 35px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  }

  .dashboard-header h2 {
    margin: 0 0 8px 0;
    font-size: 2em;
    font-weight: 700;
  }

  .dashboard-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1em;
  }

  .stat-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    border-left: 5px solid;
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-3px);
  }

  .stat-card h5 {
    margin: 0 0 8px 0;
    font-size: 0.75em;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }

  .stat-value {
    font-size: 1.8em;
    font-weight: 700;
    color: #667eea;
  }

  .stat-card.verde {
    border-left-color: #11998e;
  }

  .stat-card.rojo {
    border-left-color: #ff6b6b;
  }

  .stat-card.azul {
    border-left-color: #4facfe;
  }

  .stat-card.naranja {
    border-left-color: #f59e0b;
  }

  .stat-card.morado {
    border-left-color: #a855f7;
  }

  .section-title {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2em;
  }

  .table-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
  }

  .table-card table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9em;
  }

  .table-card thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .table-card th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 0.9em;
  }

  .table-card td {
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
  }

  .table-card tbody tr:hover {
    background-color: #f8f9ff;
  }

  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .badge-success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .badge-warning {
    background: #fff3e0;
    color: #e65100;
  }

  .badge-info {
    background: #e3f2fd;
    color: #1565c0;
  }

  .badge-cost {
    background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
    color: white;
    font-weight: 700;
  }

  .chart-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
  }

  .chart-card h4 {
    color: #667eea;
    margin-top: 0;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .export-buttons {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(79, 172, 254, 0.1);
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn-export-small {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 10px 16px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-export-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
    text-decoration: none;
  }

  .no-data {
    text-align: center;
    color: #999;
    padding: 20px;
    font-style: italic;
  }

  .grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
  }

  .chart-value-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    font-size: 0.85em;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    .top-navigation {
      flex-direction: column;
      gap: 15px;
    }

    .nav-actions {
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .btn-action {
      flex: 1 1 auto;
      min-width: 120px;
    }

    .dashboard-header {
      padding: 25px;
      text-align: center;
    }

    .dashboard-header h2 {
      font-size: 1.8em;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    .table-card table {
      font-size: 0.8em;
    }

    .table-card th, .table-card td {
      padding: 6px 5px;
    }
  }
</style>

<!-- NavegaciÃ³n Superior -->
<div class="top-navigation">
  <div class="nav-brand">
    <h3><i class="fas fa-users-cog"></i> Sistema de Empleados</h3>
  </div>
  
  <div class="nav-actions">
    <!-- Nombre de usuario a la derecha -->
    <div class="user-info" style="margin-right: 15px;">
      <i class="fas fa-user-circle"></i> 
      {% if nombre|length < 50 %}
        {{ nombre }}
      {% else %}
        {{ nombre[:47] }}...
      {% endif %}
    </div>

    {% if admin %}
    <a href="{{ url_for('admin_gestion_tiempos') }}" class="btn-action btn-turnos">
      <i class="fas fa-clock"></i> GestiÃ³n Turnos (Todos)
    </a>
    {% endif %}

    <!-- MenÃº Desplegable Elegante -->
    <div class="dropdown">
      <button class="dropdown-toggle">
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </button>
      <div class="dropdown-menu">
        <div class="menu-section">PRINCIPAL</div>
        <a href="{{ url_for('dashboard') }}" class="dropdown-item">
          <i class="fas fa-home" style="color: #6366f1;"></i> Dashboard
        </a>
        {% if not admin %}
        <a href="{{ url_for('seleccionar_turno') }}" class="dropdown-item">
          <i class="fas fa-calendar-plus" style="color: #8b5cf6;"></i> Seleccionar Turno
        </a>
        <a href="{{ url_for('ver_turnos_asignados') }}" class="dropdown-item">
          <i class="fas fa-calendar-check" style="color: #10b981;"></i> Ver Mis Turnos
        </a>
        {% endif %}

        {% if admin %}
        <div class="menu-section" style="margin-top: 8px;">ADMINISTRACIÃ“N</div>
        <a href="{{ url_for('admin_asignar_turnos') }}" class="dropdown-item">
          <i class="fas fa-calendar-plus" style="color: #8b5cf6;"></i> Asignar Turnos
        </a>
        <a href="{{ url_for('admin_usuarios') }}" class="dropdown-item">
          <i class="fas fa-users" style="color: #f59e0b;"></i> Gestionar Usuarios
        </a>
        <a href="{{ url_for('admin_backups') }}" class="dropdown-item">
          <i class="fas fa-database" style="color: #6b7280;"></i> Backups
        </a>
        <a href="{{ url_for('exportar_registros') }}" class="dropdown-item">
          <i class="fas fa-file-csv" style="color: #3b82f6;"></i> Exportar Reporte
        </a>
        {% endif %}

        <div class="menu-section" style="margin-top: 8px;">CUENTA</div>
        <a href="{{ url_for('ajustes') }}" class="dropdown-item">
          <i class="fas fa-cog" style="color: #6366f1;"></i> Ajustes
        </a>
        <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
        <a href="{{ url_for('logout') }}" class="dropdown-item" style="color: #ef4444;">
          <i class="fas fa-sign-out-alt"></i> Salir
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Panel de Control de Asistencia (Centrado y Grande) -->
{% if not admin %}
<div style="display: flex; justify-content: center; gap: 30px; margin: 40px 0;">
  <form method="POST" action="{{ url_for('marcar_inicio') }}">
    <button type="submit" class="btn-asistencia btn-inicio-grande" {% if attendance_status == 'active' %}disabled{% endif %}>
      <div class="icon-container"><i class="fas fa-fingerprint"></i></div>
      <span>Registrar Entrada</span>
    </button>
  </form>
  
  <form method="POST" action="{{ url_for('marcar_salida') }}">
    <button type="submit" class="btn-asistencia btn-salida-grande" {% if attendance_status != 'active' %}disabled{% endif %}>
      <div class="icon-container"><i class="fas fa-running"></i></div>
      <span>Registrar Salida</span>
    </button>
  </form>
</div>

<style>
  .btn-asistencia {
    border: none;
    background: white;
    border-radius: 20px;
    padding: 20px 40px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    width: 200px;
  }

  .btn-asistencia:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
  }

  .btn-asistencia:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    filter: grayscale(1);
  }

  .icon-container {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2em;
    color: white;
    margin-bottom: 5px;
  }

  .btn-inicio-grande .icon-container {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
  }

  .btn-salida-grande .icon-container {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
  }

  .btn-asistencia span {
    font-size: 1.1em;
    font-weight: 700;
    color: #374151;
  }
</style>
{% endif %}

      {% if admin %}
      <div class="menu-section" style="margin-top: 8px;">ADMINISTRACIÃ“N</div>
      <a href="{{ url_for('admin_asignar_turnos') }}" class="dropdown-item">
        <i class="fas fa-user-cog"></i> Asignar Turnos
      </a>
      <a href="{{ url_for('admin_usuarios') }}" class="dropdown-item">
        <i class="fas fa-users-cog"></i> GestiÃ³n de Usuarios
      </a>
      <a href="{{ url_for('admin_backups') }}" class="dropdown-item">
        <i class="fas fa-database"></i> Backups
      </a>
      <a href="{{ url_for('exportar_registros') }}" class="dropdown-item">
        <i class="fas fa-file-download"></i> Exportar a CSV
      </a>
      {% endif %}

<!-- Header -->
<div class="dashboard-header">
  <div>
    <h2>{% if admin %}ðŸ‘‘ Panel de GestiÃ³n Ejecutiva{% else %}ðŸ“Š Mi Panel de Control{% endif %}</h2>
    <p>{% if admin %}Centro de comando y control del sistema{% else %}Control de asistencia y gestiÃ³n personal{% endif %}</p>
  </div>
</div>

<!-- Acceso RÃ¡pido (Usuarios) -->
{% if not admin %}
<div class="table-card">
  <h3 class="section-title"><i class="fas fa-th-large"></i> Acceso RÃ¡pido a MÃ³dulos</h3>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
    <a href="{{ url_for('modulo_turnos') }}" class="btn-turnos">
      <i class="fas fa-people-group"></i>
      GestiÃ³n de Turnos
    </a>
    <a href="{{ url_for('seleccionar_turno') }}" class="btn-turnos">
      <i class="fas fa-calendar-clock"></i>
      Seleccionar Turno
    </a>
    <a href="{{ url_for('ver_turnos_asignados') }}" class="btn-turnos">
      <i class="fas fa-calendar-check"></i>
      Mis Turnos
    </a>
    <a href="{{ url_for('ajustes') }}" class="btn-turnos">
      <i class="fas fa-gear"></i>
      Mi Perfil
    </a>
  </div>
</div>
{% endif %}

<!-- Acciones RÃ¡pidas Admin -->

<!-- Tarjetas de estadÃ­sticas -->
<div class="stat-cards-grid">
  <div class="stat-card verde">
    <h5>{% if admin %}ðŸ‘¥ Total Empleados{% else %}ðŸ‘¤ Mi Perfil{% endif %}</h5>
    <div class="stat-value">{{ total_usuarios_nuevos }}</div>
  </div>
  <div class="stat-card rojo">
    <h5>âœ… Iniciados Hoy</h5>
    <div class="stat-value">{{ usuarios_iniciados_hoy }}</div>
  </div>
  <div class="stat-card azul">
    <h5>ðŸ“‹ Total Registros</h5>
    <div class="stat-value">
      {% set total = namespace(count=0) %}
      {% for usr, regs in registros.items() %}
        {% for fecha, reg in regs.items() %}
          {% set total.count = total.count + 1 %}
        {% endfor %}
      {% endfor %}
      {{ total.count }}
    </div>
  </div>
  {% if admin %}
  <div class="stat-card morado">
    <h5>ðŸ’° Costo Horas Extras</h5>
    <div class="stat-value" style="font-size: 1.8em;">$ {{ "{:,.0f}".format(costo_total_empresa) }}</div>
  </div>
  {% endif %}
</div>

<!-- Historial Detallado (AcordeÃ³n) -->
<div class="card mt-4 shadow">
  <div class="card-header bg-white border-0">
    <h3 class="section-title mb-0"><i class="fas fa-history"></i> Mi Historial de Turnos</h3>
  </div>
  <div class="card-body p-0">
    <div class="accordion" id="accordionUserHistory">
      {% for nombre_semana, dias in calendario_semanal_usuario.items() %}
      <div class="accordion-item border-0 mb-2">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
          <button class="accordion-button collapsed rounded shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}" style="background: #f8fafc;">
            <span class="fw-bold text-primary">{{ nombre_semana }}</span>
          </button>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionUserHistory">
          <div class="accordion-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Planificado</th>
                    <th>Entrada</th>
                    <th>Salida</th>
                    <th>Horas</th>
                    <th>Extras</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fecha_str, datos in dias.items() %}
                  <tr>
                    <td class="fw-bold">{{ fecha_str }}</td>
                    <td><span class="badge bg-info text-dark">{{ datos.planificado }}</span></td>
                    <td>{{ datos.inicio if datos.inicio else '-' }}</td>
                    <td>{{ datos.salida if datos.salida else '-' }}</td>
                    <td>{{ datos.horas }}h</td>
                    <td>
                      {% if datos.extras > 0 %}
                      <span class="badge bg-warning text-dark">{{ datos.extras }}h</span>
                      {% else %}
                      -
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Resumen Semanal de Turnos -->
<div class="table-card">
  <h3 class="section-title">
    <i class="fas fa-calendar-week"></i> Resumen Semanal - Turnos por Gestor
  </h3>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <tr>
          <th style="padding: 12px; text-align: left;">Gestor</th>
          {% set dias_semana_map = {'monday': 'Lunes', 'tuesday': 'Martes', 'wednesday': 'MiÃ©rcoles', 'thursday': 'Jueves', 'friday': 'Viernes', 'saturday': 'SÃ¡bado', 'sunday': 'Domingo'} %}
          {% for fecha in fechas_semana_actual %}
            <th style="padding: 12px; text-align: center;">
              {{ dias_semana_map.get(fecha.strftime('%A').lower(), '') }}<br>
              <small style="font-weight: normal; opacity: 0.8;">{{ fecha.strftime('%d/%m') }}</small>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for username, turnos_del_usuario in turnos_semana_actual.items() %}
          <tr style="border-bottom: 1px solid #e0e0e0;">
            <td style="padding: 12px; font-weight: 700;">{{ username }}</td>
            {% for fecha in fechas_semana_actual %}
              <td style="padding: 12px; text-align: center;">
                {% set dia_str = fecha.strftime('%A').lower() %}
                {% set hora_asignada = turnos_del_usuario.get(dia_str) %}
                {% if hora_asignada %}
                  <span class="badge badge-success">{{ hora_asignada }}</span>
                {% else %}
                  <span style="color: #ccc;">-</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% else %}
          <tr>
            <td colspan="{{ fechas_semana_actual|length + 1 }}" style="text-align: center; padding: 20px; color: #999;">
              No hay turnos asignados para esta semana.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-2">
  <div class="chart-card">
    <h4>ðŸ‘¥ DistribuciÃ³n de Turnos</h4>
    <canvas id="graficoInicios" style="max-height: 350px;"></canvas>
  </div>
  <div class="chart-card">
    <h4>ðŸ“Š Horas Trabajadas por DÃ­a</h4>
    <canvas id="graficoHoras" style="max-height: 350px;"></canvas>
  </div>
</div>

{% if admin %}
<div class="grid-2">
  <div class="chart-card">
    <h4>ðŸ’° Costos Horas Extras</h4>
    <canvas id="graficoCostos" style="max-height: 350px;"></canvas>
  </div>
  <div class="chart-card">
    <h4>ðŸ‘” DistribuciÃ³n de Cargos</h4>
    <div style="height: 300px; position: relative;">
      <canvas id="graficoCargos"></canvas>
    </div>
  </div>
</div>
{% endif %}
{% if admin %}
<div class="export-buttons">
  <a href="{{ url_for('exportar_registros') }}" class="btn-export-small">
    <i class="fas fa-download"></i> Registros CSV
  </a>
</div>
{% endif %}

<!-- Variables de datos del servidor -->
<script type="text/javascript">
  var serverData = {
    fechas: {{ fechas|default([])|tojson|safe }},
    horas: {{ horas_fechas|default([])|tojson|safe }},
    contadores: {{ contador_inicios|default({})|tojson|safe }}
    {% if admin %},
    costos: {{ costo_horas_extras|default({})|tojson|safe }},
    usuarios: {{ data.get('usuarios', {})|tojson|safe }}
    {% endif %}
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function() {
    
    const chartDataLabels = {
      id: 'chartDataLabels',
      afterDatasetsDraw(chart) {
        chart.data.datasets.forEach((datasetMeta, i) => {
          const meta = chart.getDatasetMeta(i);
          meta.data.forEach((bar, index) => {
            const barData = bar.$context.parsed.y;
            if (barData > 0) {
              const ctx = chart.ctx;
              ctx.fillStyle = 'rgba(0,0,0,0.7)';
              ctx.font = 'bold 11px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(barData.toFixed(1), bar.x, bar.y - 5);
            }
          });
        });
      }
    };

    const ctx1 = document.getElementById('graficoHoras');
    if (ctx1 && serverData.fechas && serverData.horas) {
      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: serverData.fechas,
          datasets: [{
            label: 'Horas trabajadas',
            data: serverData.horas,
            backgroundColor: [
              'rgba(75, 192, 192, 0.6)', // Teal Pastel
              'rgba(54, 162, 235, 0.6)', // Blue Pastel
              'rgba(153, 102, 255, 0.6)', // Purple Pastel
              'rgba(255, 159, 64, 0.6)',  // Orange Pastel
              'rgba(255, 99, 132, 0.6)',  // Red Pastel
              'rgba(255, 205, 86, 0.6)',  // Yellow Pastel
              'rgba(201, 203, 207, 0.6)'  // Grey Pastel
            ],
            borderColor: [
              'rgb(75, 192, 192)',
              'rgb(54, 162, 235)',
              'rgb(153, 102, 255)',
              'rgb(255, 159, 64)',
              'rgb(255, 99, 132)',
              'rgb(255, 205, 86)',
              'rgb(201, 203, 207)'
            ],
            borderWidth: 1,
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    const ctx2 = document.getElementById('graficoInicios');
    if (ctx2 && serverData.contadores && Object.keys(serverData.contadores).length > 0) {
      const usuarios = Object.keys(serverData.contadores);
      const inicios = Object.values(serverData.contadores);
      const totalInicios = inicios.reduce((a, b) => a + b, 0);
      const porcentajes = inicios.map(x => ((x / totalInicios) * 100).toFixed(1));

      // Crear datos combinados para mostrar en el grÃ¡fico
      const combinedData = usuarios.map((u, i) => ({
        usuario: u,
        inicios: inicios[i],
        porcentaje: porcentajes[i]
      }));

      // Ordenar por cantidad de inicios descendente
      combinedData.sort((a, b) => b.inicios - a.inicios);

      // Tomar solo los top 5 para mejor visualizaciÃ³n
      const topData = combinedData.slice(0, 5);
      const topPorcentajes = topData.map(d => d.porcentaje);

      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: topData.map(d => d.usuario),
          datasets: [{
            label: 'Inicios por usuario',
            data: topData.map(d => d.inicios),
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(54, 162, 235, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)'
            ],
            borderWidth: 1,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return value + ' inicios (' + percentage + '%)';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 },
                stepSize: 1
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    // GrÃ¡fico de costos de horas extras
    const ctx3 = document.getElementById('graficoCostos');
    if (ctx3 && serverData.costos && Object.keys(serverData.costos).length > 0) {
      const usuariosCostos = Object.keys(serverData.costos);
      const valoresCostos = Object.values(serverData.costos);

      // Filtrar solo valores mayores a 0
      const datosFiltrados = usuariosCostos.map((u, i) => ({
        usuario: u,
        costo: valoresCostos[i]
      })).filter(d => d.costo > 0);

      // Ordenar por costo descendente
      datosFiltrados.sort((a, b) => b.costo - a.costo);

      // Tomar top 5
      const topCostos = datosFiltrados.slice(0, 5);

      new Chart(ctx3, {
        type: 'bar',
        data: {
          labels: topCostos.map(d => d.usuario),
          datasets: [{
            label: 'Costo Horas Extras ($)',
            data: topCostos.map(d => d.costo),
            backgroundColor: [
              '#ff6b6b', // Rojo
              '#f093fb', // Rosa claro
              '#667eea', // Azul
              '#fa709a', // Rosa oscuro
              '#11998e'  // Verde azulado
            ].slice(0, topCostos.length),
            borderRadius: 8,
            borderSkipped: false,
            borderWidth: 0
          }]
        },
        options: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return '$' + context.parsed.y.toLocaleString();
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 },
                callback: function(value) {
                  return '$' + value.toLocaleString();
                }
              },
              grid: {
                color: 'rgba(102, 126, 234, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#667eea',
                font: { weight: 'bold', size: 11 }
              },
              grid: {
                display: false
              }
            }
          }
        },
        plugins: [chartDataLabels]
      });
    }

    // GrÃ¡fico de distribuciÃ³n de cargos
    const ctx4 = document.getElementById('graficoCargos');
    if (ctx4 && serverData.usuarios) {
      const cargosCount = {};
      Object.values(serverData.usuarios).forEach(user => {
        const cargo = user.cargo || 'Sin definir';
        cargosCount[cargo] = (cargosCount[cargo] || 0) + 1;
      });

      const cargos = Object.keys(cargosCount);
      const cantidades = Object.values(cargosCount);

      new Chart(ctx4, {
        type: 'pie',
        data: {
          labels: cargos, // Solo el nombre del cargo
          datasets: [{
            data: cantidades,
            backgroundColor: [
              '#667eea', // Azul
              '#764ba2', // Morado
              '#f093fb', // Rosa claro
              '#f5576c', // Rojo coral
              '#667eea', // Azul (repetido para mÃ¡s categorÃ­as)
              '#764ba2',
              '#fa709a',
              '#11998e',
              '#38ef7d'
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { size: 10, weight: 'bold' },
                color: '#667eea',
                padding: 8
              },
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1); // Mostrar porcentaje en tooltip
                  return value + ' empleados (' + percentage + '%)';
                }
              }
            }
          }
        }
      });
    }

  });
</script>
{% endblock %}
